# 定义 HTTP 服务器块
server {
    # 监听 IPv4 的 80 端口（HTTP）
    listen 80;
    # 监听 IPv6 的 80 端口（HTTP）
    listen [::]:80;

    # 启用 gzip 压缩
    gzip on;
    # 根据响应头 "Vary: Accept-Encoding" 启用 gzip
    gzip_vary on;
    # 设置最小压缩文件大小为 10KB
    gzip_min_length 10240;
    # 对特定代理条件下的响应启用 gzip
    gzip_proxied expired no-cache no-store private auth;
    # 指定需要压缩的 MIME 类型
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;
    # 对 IE6 及以下版本禁用 gzip
    gzip_disable "MSIE [1-6]\.";

    # 包含 MIME 类型定义文件
    include /etc/nginx/mime.types;

    # 设置安全头：防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN";
    # 设置安全头：启用 XSS 保护
    add_header X-XSS-Protection "1; mode=block";
    # 设置安全头：防止 MIME 类型嗅探
    add_header X-Content-Type-Options "nosniff";

    # 设置客户端请求体最大大小
    client_max_body_size 100M;
    # 设置客户端请求体缓冲区大小
    client_body_buffer_size 128k;
    # 设置代理连接超时时间
    proxy_connect_timeout 90;
    # 设置代理发送超时时间
    proxy_send_timeout 90;
    # 设置代理读取超时时间
    proxy_read_timeout 90;
    # 设置代理缓冲区大小
    proxy_buffer_size 4k;
    # 设置代理缓冲区的数量和大小
    proxy_buffers 4 32k;
    # 设置繁忙代理缓冲区大小
    proxy_busy_buffers_size 64k;

    # 定义根路径的请求处理
    location / {
        # 设置静态文件根目录
        root /www;
        # 设置默认索引文件
        index index.html;
        # 尝试按顺序查找文件：精确匹配 → 目录 → 回退到 index.html
        try_files $uri $uri/ /index.html;

        # 匹配静态资源文件（图片、CSS、JS等）
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            # 设置缓存过期时间为 30 天
            expires 30d;
            # 设置缓存控制头
            add_header Cache-Control "public, no-transform";
        }

        # 精确匹配 index.html 文件
        location = /index.html {
            # 设置不缓存 HTML 文件
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            # 兼容 HTTP/1.0 的缓存控制
            add_header Pragma "no-cache";
            # 设置立即过期
            expires -1;
        }

        # 当上游服务器出错时的重试机制
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        # 拦截错误响应
        proxy_intercept_errors on;

        # 设置代理请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 禁止访问以点开头的隐藏文件
    location ~ /\. {
        # 拒绝所有访问
        deny all;
        # 关闭访问日志
        access_log off;
        # 关闭未找到文件的日志记录
        log_not_found off;
    }
}