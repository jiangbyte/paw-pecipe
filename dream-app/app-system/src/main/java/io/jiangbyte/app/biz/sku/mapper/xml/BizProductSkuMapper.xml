<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.jiangbyte.app.biz.sku.mapper.BizProductSkuMapper">

    <!-- 定义 resultMap：SKU + 商品 -->
    <resultMap id="SkuWithProductResultMap" type="io.jiangbyte.app.biz.sku.dto.BizProductSkuWithProductDto">
        <!-- SKU 字段 -->
        <id property="id" column="sku_id"/>
        <result property="productId" column="product_id"/>
        <result property="originalPrice" column="original_price"/>
        <result property="discountPrice" column="discount_price"/>
        <result property="discount" column="discount"/>
        <result property="limitPerUser" column="limit_per_user"/>
        <result property="totalStock" column="total_stock"/>
        <result property="status" column="sku_status"/>
        <!-- JSON 字段：必须指定 typeHandler -->
        <result property="tags" column="tags" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>

        <!-- 关联商品信息 -->
        <association property="product" javaType="io.jiangbyte.app.biz.product.entity.BizProduct">
            <id property="id" column="product_id"/>
            <result property="title" column="title"/>
            <result property="cover" column="cover"/>
            <result property="brand" column="brand"/>
            <result property="categoryId" column="category_id"/>
            <result property="origin" column="origin"/>
            <result property="description" column="description"/>
            <result property="status" column="product_status"/>
            <!-- JSON 字段 -->
            <result property="images" column="images" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
            <result property="details" column="details" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
            <result property="service" column="service" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        </association>
    </resultMap>

    <!-- 分页查询：SKU + 商品 -->
    <select id="selectSkuWithProductPage" resultMap="SkuWithProductResultMap">
        SELECT
        s.id AS sku_id,
        s.product_id,
        s.original_price,
        s.discount_price,
        s.discount,
        s.limit_per_user,
        s.tags,
        s.total_stock,
        s.status AS sku_status,

        p.id AS product_id,
        p.title,
        p.cover,
        p.brand,
        p.category_id,
        p.origin,
        p.description,
        p.images,
        p.details,
        p.service,
        p.status AS product_status
        FROM biz_product_sku s
        LEFT JOIN biz_product p ON s.product_id = p.id
        <where>
            <if test="true">s.is_deleted = 0</if>
            <if test="true">AND p.is_deleted = 0</if>
            <if test="true">AND p.status = 1</if>

            <if test="req.keyword != null and req.keyword != ''">
                AND p.title LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.categoryId != null and req.categoryId != ''">
                AND p.category_id = #{req.categoryId}
            </if>
        </where>
    </select>

</mapper>
